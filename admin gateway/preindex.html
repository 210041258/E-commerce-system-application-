<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIN Entry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #280063; /* Dark purple background */
            font-family: 'Playfair Display', serif;
        }

        .card {
            border: none; /* Remove default card border */
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2); /* Add a subtle shadow */
        }

        .card-header {
            background-color: #6A0DAD; /* Darker purple header */
            color: white;
            border-bottom: none; /* Remove header border */
            border-top-left-radius: 10px; /* Round top corners of the card */
            border-top-right-radius: 10px;
        }

        .btn-primary {
            background-color: #6A0DAD; /* Purple button */
            border-color: #6A0DAD; /* Purple button border */
        }

        .form-control:hover {
            border-color: #6A0DAD; /* Purple border on hover */
            box-shadow: 0 0 5px rgba(106, 13, 173, 0.5); /* Subtle purple shadow */
        }

        .btn-primary:hover {
            background-color: #4b0082; /* Darker purple on hover */
            border-color: #4b0082; /* Darker purple border */
        }

        #error-message {
            display: none;
        }
    </style>
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-database.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCzT77IureChCmwMkYq45oMVpmNTJgXYUw",
            authDomain: "iutianbookshop.firebaseapp.com",
            databaseURL: "https://iutianbookshop-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iutianbookshop",
            storageBucket: "iutianbookshop.appspot.com",
            messagingSenderId: "300755004711",
            appId: "1:300755004711:web:fb9a9033b13b016cc78d02",
            measurementId: "G-64VGT3VT75"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Firebase reference
        const pinsRef = ref(database, 'pin'); // Single value at the 'pin' path

        // Function to generate a random 6-digit PIN
        function generateRandomPin(length) {
            let pin = '';
            for (let i = 0; i < length; i++) {
                pin += Math.floor(Math.random() * 10); // Generate a random digit from 0-9
            }
            return pin;
        }

        // Submit the random PIN to Firebase (as a single value)
        function submitPinToFirebase(pin) {
            set(pinsRef, pin)  // Using `set()` to store the PIN as a single value at the 'pin' path
                .then(() => {
                    console.log("PIN submitted successfully to Firebase!");
                })
                .catch((error) => {
                    console.error("Error submitting PIN to Firebase:", error);
                });
        }

        // Handle PIN form submission
        document.getElementById('pinForm').addEventListener('submit', (event) => {
            event.preventDefault(); // Prevent form submission

            const pinInput = document.getElementById('pin');
            const pin = pinInput.value;
            const errorMessage = document.getElementById('error-message');

            if (pin.length !== 4) {
                errorMessage.textContent = "Please enter a valid 4-digit PIN.";
                errorMessage.style.display = "block";
                return;
            }

            // Retrieve the stored PIN from Firebase and validate
            get(pinsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const storedPin = snapshot.val(); // Get the PIN directly (not as an object or map)

                    if (pin === storedPin) {
                        alert("PIN is correct! Redirecting to index.html...");
                        window.location.href = 'index.html'; // Redirect to index.html
                    } else {
                        errorMessage.textContent = "Incorrect PIN. Please try again.";
                        errorMessage.style.display = "block";
                    }
                } else {
                    console.log("No data available at 'pin' path.");
                    errorMessage.textContent = "No data available at 'pin' path.";
                    errorMessage.style.display = "block";
                }
            }).catch((error) => {
                console.error("Error retrieving data:", error);
                errorMessage.textContent = "Error retrieving data.";
                errorMessage.style.display = "block";
            });
        });

        // For testing purposes, generate and submit a random PIN on page load
        const randomPin = generateRandomPin(4);
        submitPinToFirebase(randomPin); // Store the generated random PIN as a single value
    </script>
</head>
<body>
    <div class="container" style="padding: 7%;">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h2 class="text-center mb-4">Enter Your PIN</h2>
                        <form id="pinForm">
                            <div class="mb-3">
                                <label for="pin" class="form-label">PIN</label>
                                <input type="password" class="form-control" id="pin" placeholder="Enter 4-digit PIN" maxlength="4" required>
                            </div>
                            <div id="error-message" class="alert alert-danger"></div>
                            <button type="submit" class="btn btn-primary" style="width: 100%;">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
